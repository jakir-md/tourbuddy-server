generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum RequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum TripCategory {
  ADVENTURE
  FOODIE
  BEACH
  CULTURAL
  CAMPAIGN
  WORK
  PHOTO
  ROAD_TRIP
}

enum ApproveStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id           String  @id @default(uuid())
  name         String
  email        String  @unique
  username     String  @unique
  password     String
  profilePhoto String?

  role       UserRole @default(USER)
  isVerified Boolean  @default(false)

  bio       String?  @db.Text
  age       Int?
  gender    String?
  interests String[]

  tripsCreated Trip[]    @relation("TripCreator")
  sentMessages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  requestTarget              JoinRequest[]         @relation("TripAdmin")
  requestCreator             JoinRequest[]         @relation("TripAttendee")
  conversations              Conversation[]
  conversationMembers        ConversationMember[]
  tripCreatorInfo            TripApproval[]        @relation("TripCreatorInfo")
  tripModeratorInfo          TripApproval[]        @relation("TripModeratorInfo")
  userProfileVerifyInfo      ProfileVerification[] @relation("userProfile")
  profileVerifyModeratorInfo ProfileVerification[] @relation("moderatorInfo")
  subscription               Subscription?
  reviewAuthor               Review[]              @relation("ReviewAuthor")
  payments                   Payment[]
  reviewTarget               Review[]              @relation("ReviewTarget")

  @@index([email])
}

model Trip {
  id          String       @id @default(uuid())
  title       String
  slug        String       @unique
  searchIndex String
  startPoint  String
  destination String
  startDate   String
  endDate     String
  budget      Int
  category    TripCategory

  approveStatus ApproveStatus @default(PENDING)
  description   String        @db.Text

  locationData Json?
  itinerary    Json?

  activities  String[]
  bannerImage String?
  userId      String
  user        User     @relation("TripCreator", fields: [userId], references: [id], onDelete: Cascade)

  joinRequests  JoinRequest[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  conversation  Conversation?
  tripApprovals TripApproval[]
  reviews       Review[]       @relation("ReviewTrip")

  @@index([destination])
  @@index([startDate])
  @@index([budget])
}

model JoinRequest {
  id      String        @id @default(uuid())
  status  RequestStatus @default(PENDING)
  message String?

  tripId String
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  attendeeId String
  attendee   User   @relation("TripAttendee", fields: [attendeeId], references: [id], onDelete: Cascade)

  tripAdminId String
  admin       User     @relation("TripAdmin", fields: [tripAdminId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tripId, attendeeId, tripAdminId])
}

model Conversation {
  id      String @id @default(uuid())
  tripId  String @unique
  title   String
  trip    Trip   @relation(fields: [tripId], references: [id])
  adminId String
  user    User   @relation(fields: [adminId], references: [id])

  messages            Message[]
  conversationMembers ConversationMember[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
}

model ConversationMember {
  id             String       @id @default(uuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([userId, conversationId])
}

model Message {
  id      String @id @default(uuid())
  content String @db.Text

  senderId String
  sender   User   @relation(fields: [senderId], references: [id])

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
}

model TripApproval {
  id            String        @id @default(uuid())
  tripId        String
  trip          Trip          @relation(fields: [tripId], references: [id])
  userId        String
  user          User          @relation("TripCreatorInfo", fields: [userId], references: [id])
  message       String?
  moderatorId   String?
  moderator     User?         @relation("TripModeratorInfo", fields: [moderatorId], references: [id])
  approveStatus ApproveStatus @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model ProfileVerification {
  id                  String        @id @default(uuid())
  userId              String
  user                User          @relation("userProfile", fields: [userId], references: [id])
  status              ApproveStatus @default(PENDING)
  fbPageLink          String?
  facebookProfileLink String?
  selfieImage         String
  nidFront            String
  nidBack             String
  message             String?
  utilityBill         String
  moderatorId         String?
  moderator           User?         @relation("moderatorInfo", fields: [moderatorId], references: [id])
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
}

model Review {
  id       String @id @default(uuid())
  rating   Int
  comment  String @db.Text
  authorId String
  author   User   @relation("ReviewAuthor", fields: [authorId], references: [id])

  targetId String
  target   User   @relation("ReviewTarget", fields: [targetId], references: [id])

  tripId    String
  trip      Trip     @relation("ReviewTrip", fields: [tripId], references: [id])
  createdAt DateTime @default(now())
}

model Payment {
  id            String        @id @default(uuid())
  amount        Float
  currency      String        @default("BDT")
  transactionId String        @unique
  valId         String?
  status        PaymentStatus @default(PENDING)

  gatewayResponse Json?

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

model Plan {
  id             String @id @default(uuid())
  name           String // e.g., "Global Nomad", "Weekend Warrior"
  description    String @db.Text
  price          Float // e.g., 500.00
  currency       String @default("BDT")
  durationInDays Int // e.g., 30 (Monthly), 365 (Yearly)

  // Dynamic Features (The "Industry Grade" part)
  // Instead of hardcoding, we store limits in JSON.
  // Example: { "maxTrips": 5, "maxRequests": 10, "isVerifiedBadge": false, canChat}
  limits Json

  isActive Boolean @default(true) // If false, new users can't buy it, but old subs remain.

  subscriptions Subscription[]
  payments      Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subscription {
  id String @id @default(uuid())

  userId String @unique // One active subscription per user usually
  user   User   @relation(fields: [userId], references: [id])

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  startDate DateTime @default(now())
  endDate   DateTime

  status SubscriptionStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Index for checking expiry quickly
  @@index([userId, status])
  @@index([endDate])
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}
