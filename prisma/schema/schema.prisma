generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum RequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum TripCategory {
  ADVENTURE
  FOODIE
  BEACH
  CULTURAL
  CAMPAIGN
  WORK
  PHOTO
  ROAD_TRIP
}

enum ApproveStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id           String  @id @default(uuid())
  name         String
  email        String  @unique
  username     String  @unique
  password     String
  profilePhoto String?

  role       UserRole @default(USER)
  isVerified Boolean  @default(false)

  bio       String?  @db.Text
  age       Int?
  gender    String?
  interests String[]

  // subscription Subscription?

  // Relations
  // reviewsReceived Review[] @relation("ReviewTarget")
  tripsCreated Trip[] @relation("TripCreator")
  // reviewsWritten  Review[] @relation("ReviewAuthor")

  sentMessages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // payments            Payment[]

  requestTarget       JoinRequest[]        @relation("TripAdmin")
  requestCreator      JoinRequest[]        @relation("TripAttendee")
  conversations       Conversation[]
  conversationMembers ConversationMember[]
  tripCreatorInfo     TripApproval[]       @relation("TripCreatorInfo")
  tripModeratorInfo   TripApproval[]       @relation("TripModeratorInfo")

  @@index([email])
}

model Trip {
  id          String       @id @default(uuid())
  title       String
  slug        String       @unique
  searchIndex String
  startPoint  String
  destination String
  startDate   String
  endDate     String
  budget      Int
  category    TripCategory

  approveStatus ApproveStatus @default(PENDING)
  description   String        @db.Text

  locationData Json?
  itinerary    Json?

  activities  String[]
  bannerImage String?
  userId      String
  user        User     @relation("TripCreator", fields: [userId], references: [id], onDelete: Cascade)

  joinRequests  JoinRequest[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  // conversation Conversation?
  conversation  Conversation?
  tripApprovals TripApproval[]

  @@index([destination])
  @@index([startDate])
  @@index([budget])
}

model JoinRequest {
  id      String        @id @default(uuid())
  status  RequestStatus @default(PENDING)
  message String?

  tripId String
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  attendeeId String
  attendee   User   @relation("TripAttendee", fields: [attendeeId], references: [id], onDelete: Cascade)

  tripAdminId String
  admin       User     @relation("TripAdmin", fields: [tripAdminId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tripId, attendeeId, tripAdminId])
}

model Conversation {
  id      String @id @default(uuid())
  tripId  String @unique
  title   String
  trip    Trip   @relation(fields: [tripId], references: [id])
  adminId String
  user    User   @relation(fields: [adminId], references: [id])

  messages            Message[]
  conversationMembers ConversationMember[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
}

model ConversationMember {
  id             String       @id @default(uuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([userId, conversationId])
}

model Message {
  id      String @id @default(uuid())
  content String @db.Text

  senderId String
  sender   User   @relation(fields: [senderId], references: [id])

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  isRead Boolean @default(false)

  createdAt DateTime @default(now())
}

model TripApproval {
  id            String        @id @default(uuid())
  tripId        String
  trip          Trip          @relation(fields: [tripId], references: [id])
  userId        String
  user          User          @relation("TripCreatorInfo", fields: [userId], references: [id])
  message       String?
  moderatorId   String?
  moderator     User?         @relation("TripModeratorInfo", fields: [moderatorId], references: [id])
  approveStatus ApproveStatus @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

// model Review {
//   id      String @id @default(uuid())
//   rating  Int // 1-5
//   comment String @db.Text

//   authorId String
//   author   User   @relation("ReviewAuthor", fields: [authorId], references: [id])

//   targetId String
//   target   User   @relation("ReviewTarget", fields: [targetId], references: [id])

//   createdAt DateTime @default(now())
// }

// model AdminLog {
//   id        String   @id @default(uuid())
//   action    String // e.g., "BANNED_USER", "VERIFIED_ID"
//   adminId   String
//   details   Json?
//   createdAt DateTime @default(now())
// }

// model Payment {
//   id       String @id @default(uuid())
//   amount   Float
//   currency String @default("BDT")

//   // SSLCommerz Specifics
//   transactionId String        @unique // The 'tran_id' you generate
//   valId         String? // The 'val_id' SSLCommerz returns on success
//   status        PaymentStatus @default(PENDING)

//   gatewayResponse Json? // Store full response for debugging (Industry Grade)

//   planId String // Track which plan they paid for
//   plan   Plan   @relation(fields: [planId], references: [id])

//   userId String
//   user   User   @relation(fields: [userId], references: [id])

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
// }

// enum PaymentStatus {
//   PENDING
//   SUCCESS
//   FAILED
//   CANCELLED
// }
